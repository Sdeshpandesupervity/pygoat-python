pool:
  vmImage: 'ubuntu-latest'

steps:

  # Set up Python environment
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.x'
      addToPath: true

  # Install necessary Python dependencies
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install Python Dependencies'

  # Generate SBOM using CycloneDX based on requirements.txt
  - script: |
      pip install cyclonedx-bom
      cyclonedx-py requirements -o reports/sbom.json
    displayName: 'Generate SBOM using CycloneDX'

  # Create Dependency-Check properties file (without API key)
  - script: |
      echo "" > dependency-check.properties  # Empty properties file, no API key
    displayName: 'Create Dependency-Check Properties File'

  # Run OWASP Dependency-Check
  - task: dependency-check-build-task@6
    inputs:
      projectName: 'pygoat-python'
      scanPath: '$(Build.SourcesDirectory)'
      outputFormat: 'ALL'
      failOnCVSS: '7'
    displayName: 'Run OWASP Dependency-Check'

  # Publish the Dependency-Check report to Azure Storage Account
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)/dependency-check-reports'
      artifactName: 'dependency-check-reports'
      publishLocation: 'Container'
    displayName: 'Publish Dependency-Check Report'
